{% extends 'TMS/base.html' %}
{% load static %}
{% block content %}

<div class="page-wrapper">
  <div class="content container-fluid">
    <div class="page-header">
      <h3 class="page-title fw-semibold text-gray-800">Fee Analytics Overview</h3>
      <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Reports</a></li>
        <li class="breadcrumb-item active">Fee Report</li>
      </ul>
    </div>

    <div class="row">
      <div class="col-md-3 col-sm-6">
        <div class="card shadow-sm border-0 rounded-3" style="background:#fef9e7;">
          <div class="card-body text-center">
            <h4 class="fw-bold text-dark">₹{{ total_collected }}</h4>
            <p class="text-secondary mb-0">Total Collected</p>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card shadow-sm border-0 rounded-3" style="background:#fdecea;">
          <div class="card-body text-center">
            <h4 class="fw-bold text-dark">₹{{ total_due }}</h4>
            <p class="text-secondary mb-0">Total Due</p>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card shadow-sm border-0 rounded-3" style="background:#e8f8f5;">
          <div class="card-body text-center">
            <h4 class="fw-bold text-dark">{{ total_students }}</h4>
            <p class="text-secondary mb-0">Total Students</p>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card shadow-sm border-0 rounded-3" style="background:#ebf5fb;">
          <div class="card-body text-center">
            <h4 class="fw-bold text-dark">{{ paid_count }}</h4>
            <p class="text-secondary mb-0">Fully Paid</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row mt-3">
      <div class="col-lg-6">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-header bg-white border-0">
            <h6 class="fw-semibold text-muted mb-0">Payment Status Distribution</h6>
          </div>
          <div class="card-body">
            <canvas id="statusChart" height="200"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-header bg-white border-0">
            <h6 class="fw-semibold text-muted mb-0">Collection vs Due Overview</h6>
          </div>
          <div class="card-body">
            <canvas id="collectionChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0 rounded-3 mt-3">
      <div class="card-header bg-white border-0">
        <h6 class="fw-semibold text-muted mb-0">Detailed Fee Records</h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-borderless align-middle">
            <thead class="bg-light">
              <tr>
                <th>Student</th>
                <th>Month</th>
                <th>Total</th>
                <th>Paid</th>
                <th>Remaining</th>
                <th>Status</th>
                <th>Date Paid</th>
              </tr>
            </thead>
            <tbody>
              {% for fee in fees %}
              <tr class="border-bottom">
                <td>{{ fee.student }}</td>
                <td>{{ fee.month }}</td>
                <td class="text-dark fw-semibold">₹{{ fee.total_amount }}</td>
                <td class="text-success">₹{{ fee.amount_paid }}</td>
                <td class="text-danger">₹{{ fee.remaining }}</td>
                <td>
                  {% if fee.status == 'Paid' %}
                    <span class="badge rounded-pill bg-success-subtle text-success px-3 py-2">{{ fee.status }}</span>
                  {% elif fee.status == 'Pending' %}
                    <span class="badge rounded-pill bg-danger-subtle text-danger px-3 py-2">{{ fee.status }}</span>
                  {% else %}
                    <span class="badge rounded-pill bg-warning-subtle text-warning px-3 py-2">{{ fee.status }}</span>
                  {% endif %}
                </td>
                <td>{{ fee.date_paid|date:"d M Y" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-center text-muted">No fee records found</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx1 = document.getElementById('statusChart').getContext('2d');
new Chart(ctx1, {
  type: 'doughnut',
  data: {
    labels: ['Paid', 'Pending', 'Partially Paid'],
    datasets: [{
      data: [Number('{{ paid_count|default:0 }}'), Number('{{ pending_count|default:0 }}'), Number('{{ partially_paid|default:0 }}')],
      backgroundColor: ['#5cb85c', '#f36a6a', '#f0ad4e'],
      hoverOffset: 4
    }]
  },
  options: { plugins: { legend: { position: 'bottom' } } }
});

const ctx2 = document.getElementById('collectionChart').getContext('2d');
const chart2 = new Chart(ctx2, {
  type: 'bar',
  data: {
    labels: ['Collected', 'Due'],
    datasets: [{
      label: 'Amount (₹)',
      data: ['{{ total_collected|default:0 }}', '{{ total_due|default:0 }}'],
      backgroundColor: ['#5dade2', '#f1948a'],
      borderRadius: 8
    }]
  },
  options: {
    scales: { y: { beginAtZero: true, ticks: { color: '#555' } } },
    plugins: { legend: { display: false } }
  }
});
</script>

{% endblock %}
