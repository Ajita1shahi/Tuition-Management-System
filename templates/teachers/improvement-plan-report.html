{% extends 'TMS/base.html' %}
{% load static %}
{% block content %}

<div class="page-wrapper">
  <div class="content container-fluid">

    <!-- PAGE HEADER -->
    <div class="page-header d-flex justify-content-between align-items-center">
      <div>
        <h3 class="page-title text-primary">
          <i class="fas fa-file-alt"></i> Improvement Plan Report
        </h3>
        <ul class="breadcrumb mb-0">
          <li class="breadcrumb-item">
            <a href="{% url 'teacher_dashboard' %}">Dashboard</a>
          </li>
          <li class="breadcrumb-item active">Improvement Plan Report</li>
        </ul>
      </div>
      <div class="d-none d-md-block">
        <!-- Browser print = basic "report generation" -->
        <button onclick="window.print()" class="btn btn-outline-primary">
          <i class="fas fa-print me-1"></i> Print Report
        </button>
      </div>
    </div>

    <!-- SUMMARY CARDS -->
    <div class="row mb-4">
      <!-- Total Plans -->
      <div class="col-xl-4 col-sm-6 col-12 d-flex">
        <div class="card bg-nine w-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3>{{ total_plans }}</h3>
                <h6>Total Improvement Plans</h6>
              </div>
              <div class="db-icon">
                <i class="fas fa-lightbulb"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Unread Plans -->
      <div class="col-xl-4 col-sm-6 col-12 d-flex">
        <div class="card bg-six w-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3>{{ unread_count }}</h3>
                <h6>New / Unread Plans</h6>
              </div>
              <div class="db-icon">
                <i class="fas fa-envelope-open-text"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Students with Plans -->
      <div class="col-xl-4 col-sm-6 col-12 d-flex">
        <div class="card bg-eleven w-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3>{{ distinct_students }}</h3>
                <h6>Students with Plans</h6>
              </div>
              <div class="db-icon">
                <i class="fas fa-user-graduate"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- FILTER BAR -->
    <div class="card mb-3" style="border-radius:18px;border:1px solid #f5f5ff;">
      <div class="card-body">
        <form method="get" class="row g-3 align-items-end">

          <div class="col-md-4">
            <label class="form-label">Student</label>
            <select name="student" class="form-control">
              <option value="">All Students</option>
              {% for s in students_for_filter %}
                <option value="{{ s.id }}"
                  {% if selected_student == s.id|stringformat:"s" %}selected{% endif %}>
                  {{ s.first_name }} {{ s.last_name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select name="status" class="form-control">
              <option value="all" {% if selected_status == "all" %}selected{% endif %}>All</option>
              <option value="new" {% if selected_status == "new" %}selected{% endif %}>New / Unread</option>
              <option value="read" {% if selected_status == "read" %}selected{% endif %}>Read</option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">From</label>
            <input type="date"
                   name="date_from"
                   value="{{ selected_date_from }}"
                   class="form-control">
          </div>

          <div class="col-md-2">
            <label class="form-label">To</label>
            <input type="date"
                   name="date_to"
                   value="{{ selected_date_to }}"
                   class="form-control">
          </div>

          <div class="col-md-1 text-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-filter"></i>
            </button>
          </div>

        </form>
      </div>
    </div>

    <!-- REPORT TABLE -->
    <div class="card" style="border-radius:18px;">
      <div class="card-header" style="background:#f8f5ff;border-radius:18px 18px 0 0;">
        <h5 class="card-title mb-0" style="color:#5c6ac4;">
          <i class="fas fa-list me-1"></i> Improvement Plan Details
        </h5>
      </div>
      <div class="card-body p-0">
        {% if plans %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Student</th>
                  <th>Title</th>
                  <th>Weak Topics</th>
                  <th>Status</th>
                  <th>Created On</th>
                </tr>
              </thead>
              <tbody>
                {% for plan in plans %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ plan.student.first_name }} {{ plan.student.last_name }}</td>
                  <td>{{ plan.title }}</td>
                  <td>{{ plan.weak_topics|default:"â€”" }}</td>
                  <td>
                    {% if plan.is_read %}
                      <span class="badge rounded-pill" style="background:#dcfce7;color:#15803d;">
                        Read
                      </span>
                    {% else %}
                      <span class="badge rounded-pill" style="background:#e6f7ff;color:#1d7dbf;">
                        New
                      </span>
                    {% endif %}
                  </td>
                  <td>{{ plan.created_at|date:"M d, Y" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted text-center my-3">
            No improvement plans found for the selected filters.
          </p>
        {% endif %}
      </div>
    </div>

  </div>
</div>

{% endblock %}
